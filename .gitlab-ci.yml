image: docker:latest

variables:
  DOCKER_DRIVER: overlay2

services:
  - docker:dind

stages:
  - test
  - build
  - deploy
  - cleanup

# docker-compose does not come with the image normally, so lets add it
before_script:
  - apk add --update python py-pip python-dev && pip install docker-compose
  - docker version
  - docker-compose version
  - docker info

test_front_end:
  stage: test
  script:
    - docker-compose run frontend npm run lint
    - docker-compose run frontend npm run test

test_scraper:
  stage: test
  script:
    - docker-compose run scraper pytest

build_front_end:
  stage: build
  script:
    - mkdir ./front_build
    - docker-compose build frontend
    - BUILD="PROD" docker-compose run -v "$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"/front_build:/go/src/app/dist frontend

deploy_front_end:
  stage: deploy
  variables:
    CDN_BUCKET: "s3://cdn.dailywoof.space/"
    INDEX_BUCKET: "s3://dailywoof.space/"
  script:
    - pip install awscli
    - aws s3 cp ./front_build $CDN_BUCKET --recursive # Javascript and css
    - aws s3 cp ./front_build/index.html $INDEX_BUCKET # index.html
  only:
    - master

cleanup_front_end:
  stage: cleanup
  script:
    - rm -rf ./front_build

cleanup:
  stage: cleanup
  script:
    - docker-compose down
